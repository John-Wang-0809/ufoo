#!/usr/bin/env bash
# ucodex: Launch Codex and auto-join event bus
#
# Usage: ucodex [codex args...]

set -euo pipefail

# Resolve symlinks to get real script location
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
  SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
  SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
  [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Source banner
source "$PROJECT_ROOT/scripts/banner.sh" 2>/dev/null || true

# Check and initialize .ufoo (silent)
if [[ ! -d ".ufoo/bus" ]]; then
  ufoo init --modules context,bus &>/dev/null || true
fi

# Check if AGENTS.md has ufoo template (inject if not)
if [[ -f "AGENTS.md" ]] && ! grep -q "<!-- ufoo -->" "AGENTS.md" 2>/dev/null; then
  ufoo init --modules context,bus &>/dev/null || true
fi

# Generate or reuse session ID
if [[ -z "${CODEX_SESSION_ID:-}" ]]; then
  export CODEX_SESSION_ID="$(date +%s%N | shasum | head -c 8)"
fi

# Join event bus (using fixed session ID)
# Export our PID so bus.sh registers the correct process
export UFOO_PARENT_PID=$$
NICKNAME="${UFOO_NICKNAME:-}"
SUBSCRIBER=$(ufoo bus join "$CODEX_SESSION_ID" codex "$NICKNAME" 2>/dev/null | tail -1)

# Auto-start project-level daemon (if not running)
DAEMON_STATUS=""
PID_FILE=".ufoo/bus/.daemon.pid"
if [[ -f "$PID_FILE" ]]; then
  existing="$(cat "$PID_FILE" 2>/dev/null || true)"
  if [[ -n "$existing" ]] && kill -0 "$existing" 2>/dev/null; then
    DAEMON_STATUS="running"
  else
    ufoo bus daemon --daemon &>/dev/null && DAEMON_STATUS="started"
  fi
else
  ufoo bus daemon --daemon &>/dev/null && DAEMON_STATUS="started"
fi

# Show banner
if type show_banner &>/dev/null; then
  show_banner "codex" "$CODEX_SESSION_ID" "$SUBSCRIBER" "$DAEMON_STATUS"
else
  echo "[ucodex] Connected -> $SUBSCRIBER"
  echo "[ucodex] Daemon: $DAEMON_STATUS"
  echo ""
fi

exec codex "$@"
