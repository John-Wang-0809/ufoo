#!/usr/bin/env bash
# uclaude: 启动 Claude Code 并自动加入事件总线
#
# 用法: uclaude [claude 参数...]

set -euo pipefail

# 自动初始化 .ufoo（如果不存在）
if [[ ! -d ".ufoo/bus" ]]; then
  echo "[uclaude] 初始化项目总线..."
  ufoo init --modules context,bus 2>/dev/null || true
fi

# 生成或复用 session ID
if [[ -z "${CLAUDE_SESSION_ID:-}" ]]; then
  export CLAUDE_SESSION_ID="$(date +%s%N | shasum | head -c 8)"
fi

# 加入事件总线（使用固定的 session ID）
SUBSCRIBER=$(ufoo bus join "$CLAUDE_SESSION_ID" 2>/dev/null | tail -1)
if [[ -n "$SUBSCRIBER" ]]; then
  echo "[uclaude] 已连接 → $SUBSCRIBER"
else
  echo "[uclaude] ⚠ 无法连接总线"
fi

# 自动启动项目级 daemon（如果未运行）
PID_FILE=".ufoo/bus/.daemon.pid"
if [[ -f "$PID_FILE" ]]; then
  existing="$(cat "$PID_FILE" 2>/dev/null || true)"
  if [[ -n "$existing" ]] && kill -0 "$existing" 2>/dev/null; then
    echo "[uclaude] 消息监听已就绪"
  else
    # pid 文件存在但进程已死，重启
    ufoo bus daemon --daemon 2>/dev/null && echo "[uclaude] 消息监听已启动"
  fi
else
  ufoo bus daemon --daemon 2>/dev/null && echo "[uclaude] 消息监听已启动"
fi

echo ""
# 传递 CLAUDE_SESSION_ID 环境变量给 claude 进程
exec claude "$@"
